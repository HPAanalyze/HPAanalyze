###########################
## Visualize tissue data ##
###########################

#' Visualize tissue data
#'
#' Visualize the expression of protein of interest in each target tissue by cell
#' types.
#'
#' @param data Input the list object generated by \code{hpa_download()} or
#'   \code{hpa_subset()}. Require the \code{normal_tissue} dataset.
#' @param targetGene Vector of strings of HGNC gene symbols.
#' @param targetTissue Vector of strings of normal tissues.
#' @param targetCellType Vector of strings of normal cell types.
#' @param color Vector of 4 colors used to depict different expression levels.
#' @param customTheme Logical argument. If \code{TRUE}, the function will
#'   return a barebone ggplot2 plot to be customized further.
#'
#' @return This function will return a ggplot2 plot object, which can be further
#'   modified if desirable.
#' 
#' @examples
#'   data("hpa_downloaded_histology_v18")
#'   gene_list <- c('TP53', 'EGFR', 'CD44', 'PTEN', 'IDH1', 'IDH2', 'CYCS')
#'   tissue_list <- c('breast', 'cerebellum', 'skin 1')
#'
#'   ## A typical function call   
#'   hpaVisTissue(data = hpa_downloaded_histology_v18,
#'                  targetGene = gene_list,
#'                  targetTissue = tissue_list)
#'                  
#'   \dontrun{               
#'   ## With more customization
#'   color_list <- c('white', 'red', 'green', 'blue')
#'   plot <- hpaVisTissue(data = hpa_downloaded_histology_v18,
#'                          targetGene = gene_list,
#'                          targetTissue = tissue_list,
#'                          color = color_list,
#'                          customTheme = TRUE)
#'   plot + theme_minimal()
#'   }
#'
#' @import dplyr
#' @import ggplot2
#' @export

hpaVisTissue <- function(data, 
                         targetGene, 
                         targetTissue, 
                         targetCellType = NULL,
                         color = c('#ffffb2', '#fecc5c', '#fd8d3c', '#e31a1c'),
                         customTheme = FALSE) {
    
    ## Just to pass R CMD check
    gene <- tissue <- cell_type <- level <- tissue_cell <- NULL

    plot_data <- data$normal_tissue %>%
        filter(gene %in% targetGene) %>%
        filter(tissue %in% targetTissue)
    
    if(!is.null(targetCellType)) {
        plot_data <- filter(plot_data, cell_type %in% targetCellType)
    }
    
    plot_data <- mutate(plot_data,
                        tissue_cell = paste0(tissue, ' / ', cell_type),
                        level = factor(level, levels = c('High', 'Medium', 'Low', 'Not detected')))
    
    level_colors <- c('Not detected' = color[1],
                      'Low' = color[2],
                      'Medium' = color[3],
                      'High' = color[4])
    
    plot <- ggplot(plot_data, aes(x = gene, y = tissue_cell)) +
        geom_tile(aes(fill = level)) +
        scale_x_discrete(limits = targetGene) +
        scale_fill_manual(values = level_colors)
    
    if(!customTheme) {
        plot <- plot + 
            ylab('Tissue / Cell') +
            xlab('Genes') +
            theme(axis.text.x = element_text(angle = 90, hjust = 1))
    }
    
    return(plot)       
}



##############################
## Visualize pathology data ##
##############################

#' Visualize pathology data
#'
#' Visualize the expression of genes of interest in each cancer.
#'
#' @param data Input the list object generated by \code{hpa_download()} or
#'   \code{hpa_subset()}. Require the \code{pathology} dataset.
#' @param targetGene Vector of strings of HGNC gene symbols.
#' @param targetCancer Vector of strings of normal tissues. The function will
#'   plot all available cancer by default.
#' @param color Vector of 4 colors used to depict different expression levels.
#' @param customTheme Logical argument. If \code{TRUE}, the function will
#'   return a barebone ggplot2 plot to be customized further.
#'
#' @return This function will return a ggplot2 plot object, which can be further
#'   modified if desirable.
#'
#' @examples
#'   data("hpa_downloaded_histology_v18")
#'   gene_list <- c('TP53', 'EGFR', 'CD44', 'PTEN', 'IDH1', 'IDH2', 'CYCS')
#'   cancer_list <- c('breast cancer', 'glioma', 'melanoma')
#'
#'   ## A typical function call
#'   hpaVisPatho(data = hpa_downloaded_histology_v18,
#'                  targetGene = gene_list)
#'
#'   \dontrun{
#'   ## With more customization
#'   color_list <- c('yellow', 'red', 'green', 'blue')
#'   plot <- hpaVisPatho(data = hpa_downloaded_histology_v18,
#'                             targetGene = gene_list,
#'                             targetCancer = cancer_list,
#'                             color = color_list,
#'                             customTheme = TRUE)
#'   plot + theme_minimal()
#'   }
#'
#'
#' @import dplyr
#' @import ggplot2
#' @export

hpaVisPatho <- function(data, 
                        targetGene, 
                        targetCancer = NULL, 
                        color = c('#ffffb2', '#fecc5c', '#fd8d3c', '#e31a1c'),
                        customTheme = FALSE) {
    
    ## Just to pass R CMD check
    gene <- cancer <- high <- medium <- low <- not_detected <- patient_count <- level <- NULL
    
    plot_data <- data$pathology %>%
        filter(gene %in% targetGene)
    
    if(!is.null(targetCancer)) {
        plot_data <- filter(plot_data, cancer %in% targetCancer)
    }
    
    plot_data <- plot_data %>%
        select(gene, cancer, high, medium, low, not_detected) %>%
        rename('High' = 'high', 'Medium' = 'medium', 'Low' = 'low', 'Not detected' = 'not_detected') %>%
        reshape2::melt(measure.vars = c('High', 'Medium', 'Low', 'Not detected'),
                       variable.name = 'level',
                       value.name = 'patient_count')      
    
    level_colors <- c('Not detected' = color[1],
                      'Low' = color[2],
                      'Medium' = color[3],
                      'High' = color[4])
    
    plot <- ggplot(plot_data, aes(x = gene, y = patient_count, fill = level)) +
        geom_bar(stat = 'identity', position = 'fill') +
        scale_x_discrete(limits = targetGene) +
        scale_fill_manual(values = level_colors) +
        facet_wrap(~ cancer)
    
    if(!customTheme) {
        plot <- plot + 
            ylab('Patient portions') +
            xlab('Genes') +
            theme(axis.text.x = element_text(angle = 90, hjust = 1))
    }
    
    return(plot)       
}


############################
## Visualize subcell data ##
############################

#' Visualize subcellular location data
#' 
#' Visualize the the confirmed subcellular locations of genes of interest.
#' 
#' @param data Input the list object generated by \code{hpa_download()} or
#'   \code{hpa_subset()}. Require the \code{subcellular_location} dataset.
#' @param targetGene Vector of strings of HGNC gene symbols.
#' @param color Vector of 2 colors used to depict if the protein expresses in a
#'   location or not.
#' @param customTheme Logical argument. If \code{TRUE}, the function will
#'   return a barebone ggplot2 plot to be customized further.
#'
#' @return This function will return a ggplot2 plot object, which can be further
#'   modified if desirable.
#' 
#' @examples
#'   data("hpa_downloaded_histology_v18")
#'   gene_list <- c('TP53', 'EGFR', 'CD44', 'PTEN', 'IDH1', 'IDH2', 'CYCS')
#'   
#'   ## A typical function call
#'   hpaVisSubcell(data = hpa_downloaded_histology_v18,
#'                   targetGene = gene_list)
#'   
#'   \dontrun{
#'   ## With more customization
#'   color_list <- c('white', 'red')
#'   plot <- hpaVisSubcell(data = hpa_downloaded_histology_v18,
#'                           targetGene = gene_list,
#'                           color = color_list,
#'                           customTheme = TRUE)
#'   plot + theme_minimal()
#'   }
#' 
#' 
#' @import dplyr
#' @import ggplot2
#' @export

hpaVisSubcell <- function(data, 
                          targetGene, 
                          color = c('white', 'black'),
                          customTheme = FALSE) {
    
    ## Just to pass R CMD check
    gene <- go_id <- NULL
    
    plot_data <- data$subcellular_location %>%
        filter(gene %in% targetGene) %>%
        mutate(location = strsplit(go_id, ';')) %>%
        unnest(location) %>%
        select(location, gene) %>%
        table() %>%
        as.tibble() %>%
        mutate(n = factor(n, levels = c('0', '1')))
    
    level_colors <- c('0' = color[1],
                      '1' = color[2])
    
    plot <- ggplot(plot_data, aes(x = gene, y = location)) +
        geom_tile(aes(fill = n), colour = "grey50") +
        scale_x_discrete(limits = targetGene) +
        scale_fill_manual(values = level_colors)
    
    if(!customTheme) {
        plot <- plot + 
            ylab('Subcellular locations') +
            xlab('Genes') +
            theme(axis.text.x = element_text(angle = 90, hjust = 1))  +
            theme(legend.position="none")
    }
    
    return(plot)       
}


